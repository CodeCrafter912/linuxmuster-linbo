#!/usr/bin/make -f
# Wenn man direkt
# %:
#	  dh $@
# benutzt, wird make in einer fakeroot-Umgebung ausgefÃ¼hrt. Buildroot baut das Image aber auch mit
# fakeroot, nur kann man kein fakeroot in einer fakeroot-Umgebung laufen lassen. Also alles einzeln...

DH_VERBOSE = 1
#export DH_OPTIONS=-v

BUILDROOT=$(CURDIR)/buildroot
BUILDDIR=$(CURDIR)/build
BUILD32=$(BUILDDIR)/build-i386
BUILD64=$(BUILDDIR)/build-x86_64
LINBO_VERSION=$(shell dpkg-parsechangelog -SVersion)

GRUB_COMMON_MODULES=all_video chain configfile cpuid echo net ext2 extcmd \
 fat gettext gfxmenu gfxterm http ntfs linux loadenv minicmd net part_gpt \
 part_msdos png progress reiserfs search terminal test
GRUB_PC_MODULES=biosdisk ntldr pxe
GRUB_EFI32_MODULES=efi_gop efi_uga efinet tftp
GRUB_EFI64_MODULES=efi_gop efi_uga efinet linuxefi tftp

clean:
	dh clean

.PHONY: build
build:
	echo "LINBO $(LINBO_VERSION)" > $(BUILDROOT)-external/board/rootfs_overlay/etc/linbo-version
	cd $(BUILDROOT); make O=$(BUILD32) BR2_EXTERNAL=$(BUILDROOT)-external linbo-i386_defconfig
	cd $(BUILDROOT); make O=$(BUILD64) BR2_EXTERNAL=$(BUILDROOT)-external linbo-x86_64_defconfig
	cd $(BUILDROOT); make O=$(BUILD32)
	cd $(BUILDROOT); make O=$(BUILD64)
	grub-mknetdir --net-directory=$(BUILDDIR) --subdir=/boot/grub --modules="$(GRUB_PC_MODULES) $(GRUB_COMMON_MODULES)" -d /usr/lib/grub/i386-pc
	grub-mknetdir --net-directory=$(BUILDDIR) --subdir=/boot/grub --modules="$(GRUB_EFI32_MODULES) $(GRUB_COMMON_MODULES)" -d /usr/lib/grub/i386-efi
	grub-mknetdir --net-directory=$(BUILDDIR) --subdir=/boot/grub --modules="$(GRUB_EFI64_MODULES) $(GRUB_COMMON_MODULES)" -d /usr/lib/grub/x86_64-efi
ifeq ("$(wildcard $(BUILDDIR)/ipxe.efi)","")
	wget -O $(BUILDDIR)/ipxe.efi https://boot.ipxe.org/ipxe.efi
endif
ifeq ("$(wildcard $(BUILDDIR)/ipxe.lkrn)","")
	wget -O $(BUILDDIR)/ipxe.lkrn https://boot.ipxe.org/ipxe.lkrn
endif

binary:
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs
	dh_auto_install
	dh_install
	dh_installdocs
	dh_installchangelogs
	dh_installexamples
	dh_installman
	dh_installcatalogs
	dh_installcron
	dh_installdebconf
	dh_installemacsen
	dh_installifupdown
	dh_installinfo
	dh_installinit
	dh_installmenu
	dh_installmime
	dh_installmodules
	dh_installlogcheck
	dh_installlogrotate
	dh_installpam
	dh_installppp
	dh_installudev
	dh_installgsettings
	dh_bugfiles
	dh_ucf
	dh_lintian
	dh_gconf
	dh_icons
	dh_perl
	dh_usrlocal
	dh_link
	dh_installwm
	dh_installxfonts
	dh_strip_nondeterminism
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb
